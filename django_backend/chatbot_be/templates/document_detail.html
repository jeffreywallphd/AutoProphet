{% extends 'base.html' %}
{% load static %}

{% block title %} Document details | OpenFinAL{% endblock %}

{% block content %}
<h1>Document Details</h1>

<p><strong>Created At:</strong> {{ document.created_at }}</p>
<p><strong>PDF File:</strong>
    {% if document.pdf_file %}
    <a href="{{ document.pdf_file.url }}" target="_blank">View PDF</a>
    {% else %}
    N/A
    {% endif %}
</p>

<script>
    function fetchProgress() {
        fetch("{% url 'track_progress' %}")  // Call Django API
            .then(response => response.json())
            .then(data => {
                let progressElement = document.getElementById("progress-bar");
                let textElement = document.getElementById("progress-text");

                if (data.total > 0) {
                    let percentage = Math.round((data.current / data.total) * 100);
                    progressElement.style.width = percentage + "%";
                    textElement.innerText = `Processing Paragraph ${data.current} of ${data.total}`;
                }

                if (data.current < data.total) {
                    setTimeout(fetchProgress, 1000); // Poll every 1 second
                }
            })
            .catch(error => console.error("Error fetching progress:", error));
    }

    document.addEventListener("DOMContentLoaded", function() {
        fetchProgress(); // Start polling when page loads
    });
</script>

<!-- Progress Bar UI -->
<div class="progress mt-3">
    <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
</div>
<p id="progress-text" class="mt-2">Processing...</p>


<form method="post" id="documentForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-3">
            Number of paragraphs
            {{ form.num_paragraphs }}
        </div>
        <div class="col-3">
            Number of Questions
            {{ form.num_questions }}
        </div>

        <div class="col-3">
            Test type
            {{ form.test_type }}
        </div>

    </div>

    <button type="submit" class="btn btn-primary" id="submitBtn" style="margin-top: 1vh;">
        Submit
    </button>

    
    <div id="loadingSpinner" class="spinner-border text-primary ml-2" role="status" style="display: none">
        <span class="sr-only"></span>
    </div>
</form>


<script>
    function toggleTestMode() {
        let selectedMode = document.getElementById("test_mode").value;
        let url = new URL(window.location.href);
        url.searchParams.set("test_mode", selectedMode);
        window.location.href = url.toString();  // Reload page with selected mode
    }
</script>

<div class="row">
    <div class="col-6">
        <p><strong>Text</strong></p>
        <p>{{ document.content|linebreaks }}</p>
    </div>
    <div class="col-6">
        {% if json_data %}
        <p><strong>JSON Output</strong></p>
        
        <a href="{% url 'download_json' document.id %}" class="btn btn-success mt-3">
            Download JSON
        </a>

        <pre>{{ json_data|json_script:"jsonData" }}</pre>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var jsonData = JSON.parse(document.getElementById("jsonData").textContent);
                document.getElementById("jsonOutput").textContent = JSON.stringify(jsonData, null, 4);
            });

            document.getElementById("documentForm").addEventListener("submit", function (event) {
               
                document.getElementById("loadingSpinner").style.display = "inline-block"; 
                document.getElementById("submitBtn").disabled = true;

                
                setTimeout(() => {
                    event.target.submit();  
                }, 1000);  
               
                event.preventDefault();  
            });
        </script>

        <pre id="jsonOutput"></pre>
        {% endif %}
    </div>
</div>

{% endblock %}
